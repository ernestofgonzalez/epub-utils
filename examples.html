<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Output Formats Reference" href="formats.html" /><link rel="prev" title="Use as a Python library" href="api-tutorial.html" />

    <!-- Generated with Sphinx 6.2.0 and Furo 2022.12.07 -->
        <title>Examples and Use Cases - epub-utils 0.1.0a1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?digest=91d0f0d1c444bdcb17a68e833c7a53903343c195" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">epub-utils 0.1.0a1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">epub-utils 0.1.0a1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli-tutorial.html">Use as a command-line tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-tutorial.html">Use as a Python library</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Examples and Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="formats.html">Output Formats Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cli-reference.html">CLI Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="epub-standards.html">EPUB Standards</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="examples-and-use-cases">
<h1>Examples and Use Cases<a class="headerlink" href="#examples-and-use-cases" title="Permalink to this heading">#</a></h1>
<p>This page showcases real-world examples of using epub-utils for various tasks. Each example
includes both CLI and Python API approaches where applicable.</p>
<section id="digital-library-management">
<h2>Digital Library Management<a class="headerlink" href="#digital-library-management" title="Permalink to this heading">#</a></h2>
<section id="cataloging-your-epub-collection">
<h3>Cataloging Your EPUB Collection<a class="headerlink" href="#cataloging-your-epub-collection" title="Permalink to this heading">#</a></h3>
<p><strong>Scenario</strong>: You have a large collection of EPUB files and want to create a comprehensive catalog.</p>
<p><strong>CLI Approach</strong>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># catalog-epubs.sh - Create a catalog of all EPUB files</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Creating EPUB catalog...&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;File,Title,Author,Publisher,Language,Year,Files,Size&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>epub_catalog.csv

find<span class="w"> </span>.<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.epub&quot;</span><span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>epub<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Processing: </span><span class="nv">$epub</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># Extract metadata using epub-utils</span>
<span class="w">    </span><span class="nv">metadata</span><span class="o">=</span><span class="k">$(</span>epub-utils<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub</span><span class="s2">&quot;</span><span class="w"> </span>metadata<span class="w"> </span>--format<span class="w"> </span>kv<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="k">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">title</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$metadata</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;^title:&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39; &#39;</span><span class="w"> </span>-f2-<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/,/;/g&#39;</span><span class="k">)</span>
<span class="w">        </span><span class="nv">author</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$metadata</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;^creator:&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39; &#39;</span><span class="w"> </span>-f2-<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/,/;/g&#39;</span><span class="k">)</span>
<span class="w">        </span><span class="nv">publisher</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$metadata</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;^publisher:&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39; &#39;</span><span class="w"> </span>-f2-<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/,/;/g&#39;</span><span class="k">)</span>
<span class="w">        </span><span class="nv">language</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$metadata</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;^language:&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39; &#39;</span><span class="w"> </span>-f2-<span class="k">)</span>
<span class="w">        </span><span class="nv">year</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$metadata</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;^date:&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39; &#39;</span><span class="w"> </span>-f2-<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39;-&#39;</span><span class="w"> </span>-f1<span class="k">)</span>

<span class="w">        </span><span class="c1"># Count files and get size</span>
<span class="w">        </span><span class="nv">file_count</span><span class="o">=</span><span class="k">$(</span>epub-utils<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub</span><span class="s2">&quot;</span><span class="w"> </span>files<span class="w"> </span>--format<span class="w"> </span>raw<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l<span class="k">)</span>
<span class="w">        </span><span class="nv">size</span><span class="o">=</span><span class="k">$(</span>stat<span class="w"> </span>-f%z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="o">||</span><span class="w"> </span>stat<span class="w"> </span>-c%s<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="k">)</span>

<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub</span><span class="s2">,</span><span class="nv">$title</span><span class="s2">,</span><span class="nv">$author</span><span class="s2">,</span><span class="nv">$publisher</span><span class="s2">,</span><span class="nv">$language</span><span class="s2">,</span><span class="nv">$year</span><span class="s2">,</span><span class="nv">$file_count</span><span class="s2">,</span><span class="nv">$size</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>epub_catalog.csv
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub</span><span class="s2">,ERROR,ERROR,ERROR,ERROR,ERROR,ERROR,ERROR&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>epub_catalog.csv
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Catalog complete! See epub_catalog.csv&quot;</span>
</pre></div>
</div>
<p><strong>Python Approach</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">epub_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_epub_catalog</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;epub_catalog.csv&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a comprehensive catalog of EPUB files.&quot;&quot;&quot;</span>

    <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;filepath&#39;</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;publisher&#39;</span><span class="p">,</span>
        <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;isbn&#39;</span><span class="p">,</span> <span class="s1">&#39;file_count&#39;</span><span class="p">,</span> <span class="s1">&#39;size_bytes&#39;</span><span class="p">,</span> <span class="s1">&#39;size_mb&#39;</span>
    <span class="p">]</span>

    <span class="n">epub_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.epub&quot;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">epub_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> EPUB files&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">epub_path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">epub_files</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">epub_files</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">epub_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">epub_path</span><span class="p">))</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">metadata</span>

                <span class="c1"># Extract date year</span>
                <span class="n">date_str</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">year</span> <span class="o">=</span> <span class="n">date_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">date_str</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

                <span class="c1"># Get file size</span>
                <span class="n">size_bytes</span> <span class="o">=</span> <span class="n">epub_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span>
                <span class="n">size_mb</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">size_bytes</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

                <span class="n">row</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;filepath&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">epub_path</span><span class="p">),</span>
                    <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">epub_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;creator&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;publisher&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;publisher&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">year</span><span class="p">,</span>
                    <span class="s1">&#39;isbn&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;file_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get_files_info</span><span class="p">()),</span>
                    <span class="s1">&#39;size_bytes&#39;</span><span class="p">:</span> <span class="n">size_bytes</span><span class="p">,</span>
                    <span class="s1">&#39;size_mb&#39;</span><span class="p">:</span> <span class="n">size_mb</span>
                <span class="p">}</span>

                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Write error row</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">({</span>
                    <span class="s1">&#39;filepath&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">epub_path</span><span class="p">),</span>
                    <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">epub_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;ERROR: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;publisher&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;isbn&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;file_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s1">&#39;size_bytes&#39;</span><span class="p">:</span> <span class="n">epub_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span><span class="p">,</span>
                    <span class="s1">&#39;size_mb&#39;</span><span class="p">:</span> <span class="mi">0</span>
                <span class="p">})</span>

<span class="c1"># Usage</span>
<span class="n">create_epub_catalog</span><span class="p">(</span><span class="s2">&quot;/path/to/your/epub/collection&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="quality-assurance-and-validation">
<h2>Quality Assurance and Validation<a class="headerlink" href="#quality-assurance-and-validation" title="Permalink to this heading">#</a></h2>
<section id="epub-health-check">
<h3>EPUB Health Check<a class="headerlink" href="#epub-health-check" title="Permalink to this heading">#</a></h3>
<p><strong>Scenario</strong>: Validate EPUB files and identify potential issues.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">epub_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span><span class="p">,</span> <span class="n">ParseError</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span><span class="w"> </span><span class="nc">EPUBHealthChecker</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_epub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epub_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Comprehensive EPUB health check.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">epub_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">epub_path</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking EPUB: </span><span class="si">{</span><span class="n">epub_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Basic file checks</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">epub_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;File does not exist&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_report</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">epub_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;File is empty&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_report</span><span class="p">()</span>

        <span class="c1"># ZIP integrity check</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">epub_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
                <span class="n">corrupt_files</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">testzip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">corrupt_files</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Corrupt ZIP file: </span><span class="si">{</span><span class="n">corrupt_files</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">BadZipFile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Invalid ZIP file&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_report</span><span class="p">()</span>

        <span class="c1"># EPUB structure checks</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">epub_path</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_container</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_package</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_metadata</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_manifest</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_files</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parse error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_report</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check container structure.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">container</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">container</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">container</span><span class="o">.</span><span class="n">rootfile_path</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No rootfile specified in container&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Container error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check package/OPF file.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">package</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">package</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Package missing metadata&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="s1">&#39;manifest&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Package missing manifest&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="s1">&#39;spine&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Package missing spine&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Package error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check metadata quality.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">metadata</span>

            <span class="c1"># Check required fields</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing or empty title&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing or empty language&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing or empty identifier&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metadata error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_manifest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check manifest integrity.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">manifest</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">manifest</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">manifest</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Empty manifest&quot;</span><span class="p">)</span>

            <span class="c1"># Check for common content types</span>
            <span class="n">has_html</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;media-type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;application/xhtml+xml&#39;</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">manifest</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_html</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No XHTML content files found&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Manifest error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check file structure.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">files_info</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_files_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files_info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># At least container, package, and one content file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Very few files in EPUB (possibly incomplete)&quot;</span><span class="p">)</span>

            <span class="c1"># Check for suspiciously large files</span>
            <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">files_info</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file_info</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>  <span class="c1"># 10MB</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Large file found: </span><span class="si">{</span><span class="n">file_info</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">file_info</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> bytes)&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File check error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate health check report.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span> <span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;issues_found&quot;</span><span class="p">,</span> <span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">issues</span><span class="p">}</span>

<span class="c1"># Usage</span>
<span class="n">checker</span> <span class="o">=</span> <span class="n">EPUBHealthChecker</span><span class="p">()</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">checker</span><span class="o">.</span><span class="n">check_epub</span><span class="p">(</span><span class="s2">&quot;book.epub&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;healthy&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ EPUB is healthy!&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠ Issues found:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">issue</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;issues&quot;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">issue</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="metadata-management">
<h2>Metadata Management<a class="headerlink" href="#metadata-management" title="Permalink to this heading">#</a></h2>
<section id="standardizing-metadata">
<h3>Standardizing Metadata<a class="headerlink" href="#standardizing-metadata" title="Permalink to this heading">#</a></h3>
<p><strong>Scenario</strong>: Clean and standardize metadata across your EPUB collection.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">epub_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MetadataStandardizer</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">language_codes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;english&#39;</span><span class="p">:</span> <span class="s1">&#39;en&#39;</span><span class="p">,</span>
            <span class="s1">&#39;spanish&#39;</span><span class="p">:</span> <span class="s1">&#39;es&#39;</span><span class="p">,</span>
            <span class="s1">&#39;french&#39;</span><span class="p">:</span> <span class="s1">&#39;fr&#39;</span><span class="p">,</span>
            <span class="s1">&#39;german&#39;</span><span class="p">:</span> <span class="s1">&#39;de&#39;</span><span class="p">,</span>
            <span class="s1">&#39;italian&#39;</span><span class="p">:</span> <span class="s1">&#39;it&#39;</span>
            <span class="c1"># Add more as needed</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epub_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyze and suggest metadata improvements.&quot;&quot;&quot;</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span><span class="n">epub_path</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">metadata</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Check title</span>
        <span class="n">title</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing title&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Title is very long (&gt;200 chars)&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">title</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Title is all uppercase - consider title case&quot;</span><span class="p">)</span>

        <span class="c1"># Check author</span>
        <span class="n">creator</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;creator&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">creator</span><span class="p">:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing author/creator&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;,&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">creator</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">creator</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Author name might need reformatting (Last, First)&quot;</span><span class="p">)</span>

        <span class="c1"># Check language</span>
        <span class="n">language</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">language</span><span class="p">:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing language code&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">language</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Might be full language name instead of code</span>
            <span class="n">lang_lower</span> <span class="o">=</span> <span class="n">language</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">lang_lower</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">language_codes</span><span class="p">:</span>
                <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Use language code &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">language_codes</span><span class="p">[</span><span class="n">lang_lower</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; instead of &#39;</span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Check identifier</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing identifier&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_valid_identifier</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Identifier format might be invalid&quot;</span><span class="p">)</span>

        <span class="c1"># Check date format</span>
        <span class="n">date</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d</span><span class="si">{4}</span><span class="s1">(-\d</span><span class="si">{2}</span><span class="s1">-\d</span><span class="si">{2}</span><span class="s1">)?&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Date should be in YYYY or YYYY-MM-DD format&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">epub_path</span><span class="p">,</span>
            <span class="s1">&#39;current_metadata&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                <span class="s1">&#39;creator&#39;</span><span class="p">:</span> <span class="n">creator</span><span class="p">,</span>
                <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="n">language</span><span class="p">,</span>
                <span class="s1">&#39;identifier&#39;</span><span class="p">:</span> <span class="n">identifier</span><span class="p">,</span>
                <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span>
            <span class="p">},</span>
            <span class="s1">&#39;suggestions&#39;</span><span class="p">:</span> <span class="n">suggestions</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_valid_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if identifier looks valid.&quot;&quot;&quot;</span>
        <span class="c1"># Check for ISBN, DOI, UUID patterns</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">r</span><span class="s1">&#39;urn:isbn:\d{10,13}&#39;</span><span class="p">,</span>  <span class="c1"># ISBN URN</span>
            <span class="sa">r</span><span class="s1">&#39;isbn:\d{10,13}&#39;</span><span class="p">,</span>      <span class="c1"># Simple ISBN</span>
            <span class="sa">r</span><span class="s1">&#39;urn:uuid:[a-f0-9-]</span><span class="si">{36}</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="c1"># UUID URN</span>
            <span class="sa">r</span><span class="s1">&#39;doi:10\.\d+/.+&#39;</span><span class="p">,</span>      <span class="c1"># DOI</span>
            <span class="sa">r</span><span class="s1">&#39;urn:doi:10\.\d+/.+&#39;</span>   <span class="c1"># DOI URN</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">)</span>

<span class="c1"># Usage</span>
<span class="n">standardizer</span> <span class="o">=</span> <span class="n">MetadataStandardizer</span><span class="p">()</span>
<span class="n">analysis</span> <span class="o">=</span> <span class="n">standardizer</span><span class="o">.</span><span class="n">analyze_metadata</span><span class="p">(</span><span class="s2">&quot;book.epub&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyzing: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;suggestions&#39;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Suggestions for improvement:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">suggestion</span> <span class="ow">in</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;suggestions&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">suggestion</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Metadata looks good!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="content-analysis-and-statistics">
<h2>Content Analysis and Statistics<a class="headerlink" href="#content-analysis-and-statistics" title="Permalink to this heading">#</a></h2>
<section id="reading-level-analysis">
<h3>Reading Level Analysis<a class="headerlink" href="#reading-level-analysis" title="Permalink to this heading">#</a></h3>
<p><strong>Scenario</strong>: Analyze EPUB content to determine reading complexity.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">epub_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ReadingLevelAnalyzer</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_epub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epub_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyze reading level of an EPUB.&quot;&quot;&quot;</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span><span class="n">epub_path</span><span class="p">)</span>

        <span class="c1"># Get all text content</span>
        <span class="n">all_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_all_text</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No readable text found&quot;</span><span class="p">}</span>

        <span class="c1"># Calculate statistics</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_text_stats</span><span class="p">(</span><span class="n">all_text</span><span class="p">)</span>

        <span class="c1"># Calculate reading level scores</span>
        <span class="n">flesch_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flesch_reading_ease</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
        <span class="n">flesch_grade</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flesch_kincaid_grade</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">),</span>
            <span class="s1">&#39;word_count&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;words&#39;</span><span class="p">],</span>
            <span class="s1">&#39;sentence_count&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sentences&#39;</span><span class="p">],</span>
            <span class="s1">&#39;syllable_count&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;syllables&#39;</span><span class="p">],</span>
            <span class="s1">&#39;avg_words_per_sentence&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;words&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sentences&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;avg_syllables_per_word&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;syllables&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;words&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;flesch_reading_ease&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">flesch_score</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;flesch_kincaid_grade&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">flesch_grade</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;reading_level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interpret_flesch_score</span><span class="p">(</span><span class="n">flesch_score</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_all_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract all readable text from EPUB.&quot;&quot;&quot;</span>
        <span class="c1"># This is a simplified version - real implementation would</span>
        <span class="c1"># need to parse XHTML content files</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">manifest</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">manifest</span>
            <span class="c1"># In a real implementation, you&#39;d extract and parse each content file</span>
            <span class="c1"># For now, return placeholder</span>
            <span class="k">return</span> <span class="s2">&quot;Sample text for analysis. This would contain the actual book content.&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_text_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate basic text statistics.&quot;&quot;&quot;</span>
        <span class="c1"># Clean text</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^\w\s\.\!\?]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="c1"># Count words</span>
        <span class="n">words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

        <span class="c1"># Count sentences</span>
        <span class="n">sentences</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[.!?]+&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">sentences</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sentences</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Avoid division by zero</span>

        <span class="c1"># Count syllables (simplified)</span>
        <span class="n">syllables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_syllables</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;words&#39;</span><span class="p">:</span> <span class="n">words</span><span class="p">,</span>
            <span class="s1">&#39;sentences&#39;</span><span class="p">:</span> <span class="n">sentences</span><span class="p">,</span>
            <span class="s1">&#39;syllables&#39;</span><span class="p">:</span> <span class="n">syllables</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_count_syllables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simplified syllable counting.&quot;&quot;&quot;</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">syllable_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
            <span class="n">word</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^a-z]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">word</span><span class="p">:</span>
                <span class="c1"># Simple syllable counting heuristic</span>
                <span class="n">vowels</span> <span class="o">=</span> <span class="s1">&#39;aeiouy&#39;</span>
                <span class="n">syllables</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                              <span class="k">if</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">vowels</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vowels</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">syllables</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">syllables</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">syllable_count</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">syllables</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">syllable_count</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_flesch_reading_ease</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stats</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate Flesch Reading Ease score.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="mf">206.835</span> <span class="o">-</span>
                <span class="p">(</span><span class="mf">1.015</span> <span class="o">*</span> <span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;words&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sentences&#39;</span><span class="p">]))</span> <span class="o">-</span>
                <span class="p">(</span><span class="mf">84.6</span> <span class="o">*</span> <span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;syllables&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;words&#39;</span><span class="p">])))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_flesch_kincaid_grade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stats</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate Flesch-Kincaid Grade Level.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">((</span><span class="mf">0.39</span> <span class="o">*</span> <span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;words&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sentences&#39;</span><span class="p">]))</span> <span class="o">+</span>
                <span class="p">(</span><span class="mf">11.8</span> <span class="o">*</span> <span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;syllables&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;words&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="mf">15.59</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_interpret_flesch_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Interpret Flesch Reading Ease score.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">90</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Very Easy (5th grade)&quot;</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">80</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Easy (6th grade)&quot;</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Fairly Easy (7th grade)&quot;</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Standard (8th-9th grade)&quot;</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Fairly Difficult (10th-12th grade)&quot;</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Difficult (College level)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Very Difficult (Graduate level)&quot;</span>

<span class="c1"># Usage</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">ReadingLevelAnalyzer</span><span class="p">()</span>
<span class="n">analysis</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">analyze_epub</span><span class="p">(</span><span class="s2">&quot;book.epub&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading Level Analysis for: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Word Count: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;word_count&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading Level: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;reading_level&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flesch-Kincaid Grade: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;flesch_kincaid_grade&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="direct-file-access-and-extraction">
<h3>Direct File Access and Extraction<a class="headerlink" href="#direct-file-access-and-extraction" title="Permalink to this heading">#</a></h3>
<p><strong>Scenario</strong>: Extract specific files from EPUB archives for processing or analysis.</p>
<p><strong>CLI Approach</strong>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># extract-epub-assets.sh - Extract and process EPUB content files</span>

<span class="nv">epub_file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="nv">output_dir</span><span class="o">=</span><span class="s2">&quot;extracted_content&quot;</span>

mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$output_dir</span><span class="s2">&quot;</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Extracting content from: </span><span class="nv">$epub_file</span><span class="s2">&quot;</span>

<span class="c1"># Get list of all XHTML content files</span>
epub-utils<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub_file</span><span class="s2">&quot;</span><span class="w"> </span>files<span class="w"> </span>--format<span class="w"> </span>raw<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;\.xhtml$&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>file_path<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Processing: </span><span class="nv">$file_path</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># Extract plain text content</span>
<span class="w">    </span><span class="nv">safe_name</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file_path</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="k">)</span>
<span class="w">    </span>epub-utils<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub_file</span><span class="s2">&quot;</span><span class="w"> </span>files<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file_path</span><span class="s2">&quot;</span><span class="w"> </span>--format<span class="w"> </span>plain<span class="w"> </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$output_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">safe_name</span><span class="si">}</span><span class="s2">.txt&quot;</span>

<span class="w">    </span><span class="c1"># Extract styled HTML content</span>
<span class="w">    </span>epub-utils<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub_file</span><span class="s2">&quot;</span><span class="w"> </span>files<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file_path</span><span class="s2">&quot;</span><span class="w"> </span>--format<span class="w"> </span>raw<span class="w"> </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$output_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">safe_name</span><span class="si">}</span><span class="s2">.html&quot;</span>
<span class="k">done</span>

<span class="c1"># Extract CSS files for styling reference</span>
epub-utils<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub_file</span><span class="s2">&quot;</span><span class="w"> </span>files<span class="w"> </span>--format<span class="w"> </span>raw<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;\.css$&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>css_path<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Extracting CSS: </span><span class="nv">$css_path</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">safe_name</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$css_path</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="k">)</span>
<span class="w">    </span>epub-utils<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub_file</span><span class="s2">&quot;</span><span class="w"> </span>files<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$css_path</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$output_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">safe_name</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">done</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Extraction complete! Files saved to </span><span class="nv">$output_dir</span><span class="s2">/&quot;</span>
</pre></div>
</div>
<p><strong>Comparing files vs content commands</strong>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Using files command (direct path access)</span>
epub-utils<span class="w"> </span>book.epub<span class="w"> </span>files<span class="w"> </span>OEBPS/chapter1.xhtml<span class="w"> </span>--format<span class="w"> </span>plain
epub-utils<span class="w"> </span>book.epub<span class="w"> </span>files<span class="w"> </span>OEBPS/styles/main.css
epub-utils<span class="w"> </span>book.epub<span class="w"> </span>files<span class="w"> </span>META-INF/container.xml

<span class="c1"># Using content command (requires manifest item ID)</span>
epub-utils<span class="w"> </span>book.epub<span class="w"> </span>manifest<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>chapter1<span class="w">  </span><span class="c1"># Find the ID first</span>
epub-utils<span class="w"> </span>book.epub<span class="w"> </span>content<span class="w"> </span>chapter1-id<span class="w"> </span>--format<span class="w"> </span>plain
</pre></div>
</div>
<p><strong>Key advantages of the files command</strong>:</p>
<ul class="simple">
<li><p><strong>Direct access</strong>: Use actual file paths without needing manifest IDs</p></li>
<li><p><strong>Universal file access</strong>: Access any file type (XHTML, CSS, XML, images, etc.)</p></li>
<li><p><strong>Simpler automation</strong>: No need to parse manifest to find item IDs</p></li>
<li><p><strong>Better for file-system-based workflows</strong>: Mirrors actual EPUB structure</p></li>
</ul>
<p><strong>Python equivalent using API</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">epub_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span>

<span class="k">def</span><span class="w"> </span><span class="nf">extract_file_content</span><span class="p">(</span><span class="n">epub_path</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract content from a specific file in EPUB.&quot;&quot;&quot;</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span><span class="n">epub_path</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_file_by_path</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># Handle different content types</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;to_plain&#39;</span><span class="p">):</span>
            <span class="c1"># XHTML content - can extract plain text</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;raw_html&#39;</span><span class="p">:</span> <span class="n">content</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span>
                <span class="s1">&#39;plain_text&#39;</span><span class="p">:</span> <span class="n">content</span><span class="o">.</span><span class="n">to_plain</span><span class="p">(),</span>
                <span class="s1">&#39;formatted_xml&#39;</span><span class="p">:</span> <span class="n">content</span><span class="o">.</span><span class="n">to_xml</span><span class="p">(</span><span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Other file types (CSS, XML, etc.)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;raw_content&#39;</span><span class="p">:</span> <span class="n">content</span><span class="p">}</span>

    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># Usage</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span><span class="s2">&quot;book.epub&quot;</span><span class="p">)</span>

<span class="c1"># Extract chapter content</span>
<span class="n">chapter_content</span> <span class="o">=</span> <span class="n">extract_file_content</span><span class="p">(</span><span class="s2">&quot;book.epub&quot;</span><span class="p">,</span> <span class="s2">&quot;OEBPS/chapter1.xhtml&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;plain_text&#39;</span> <span class="ow">in</span> <span class="n">chapter_content</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chapter text: </span><span class="si">{</span><span class="n">chapter_content</span><span class="p">[</span><span class="s1">&#39;plain_text&#39;</span><span class="p">][:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

<span class="c1"># Extract CSS for styling analysis</span>
<span class="n">css_content</span> <span class="o">=</span> <span class="n">extract_file_content</span><span class="p">(</span><span class="s2">&quot;book.epub&quot;</span><span class="p">,</span> <span class="s2">&quot;OEBPS/styles/main.css&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;raw_content&#39;</span> <span class="ow">in</span> <span class="n">css_content</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSS rules: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">css_content</span><span class="p">[</span><span class="s1">&#39;raw_content&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">))</span><span class="si">}</span><span class="s2"> rules found&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="automation-and-workflows">
<h2>Automation and Workflows<a class="headerlink" href="#automation-and-workflows" title="Permalink to this heading">#</a></h2>
<section id="automated-epub-processing-pipeline">
<h3>Automated EPUB Processing Pipeline<a class="headerlink" href="#automated-epub-processing-pipeline" title="Permalink to this heading">#</a></h3>
<p><strong>Scenario</strong>: Set up an automated pipeline for processing new EPUB files.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">epub_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span>

<span class="k">class</span><span class="w"> </span><span class="nc">EPUBProcessor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">processed_dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">input_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processed_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">processed_dir</span><span class="p">)</span>

        <span class="c1"># Create directories if they don&#39;t exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processed_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_new_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process all new EPUB files in input directory.&quot;&quot;&quot;</span>
        <span class="n">epub_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.epub&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">epub_files</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No EPUB files found to process&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">epub_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> EPUB files to process&quot;</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">epub_path</span> <span class="ow">in</span> <span class="n">epub_files</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_single_file</span><span class="p">(</span><span class="n">epub_path</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="c1"># Generate processing report</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_report</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_single_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epub_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a single EPUB file.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing: </span><span class="si">{</span><span class="n">epub_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">epub_path</span><span class="p">))</span>

            <span class="c1"># Extract metadata</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_metadata</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>

            <span class="c1"># Validate file</span>
            <span class="n">validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_epub</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>

            <span class="c1"># Generate file info</span>
            <span class="n">file_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_file_info</span><span class="p">(</span><span class="n">epub_path</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>

            <span class="c1"># Create organized filename</span>
            <span class="n">new_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_organized_filename</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

            <span class="c1"># Move file to organized location</span>
            <span class="n">organized_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">organize_file</span><span class="p">(</span><span class="n">epub_path</span><span class="p">,</span> <span class="n">new_filename</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;original_path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">epub_path</span><span class="p">),</span>
                <span class="s1">&#39;new_path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">organized_path</span><span class="p">),</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
                <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">,</span>
                <span class="s1">&#39;validation&#39;</span><span class="p">:</span> <span class="n">validation_result</span><span class="p">,</span>
                <span class="s1">&#39;file_info&#39;</span><span class="p">:</span> <span class="n">file_info</span><span class="p">,</span>
                <span class="s1">&#39;processed_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="c1"># Move original to processed directory</span>
            <span class="n">processed_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_dir</span> <span class="o">/</span> <span class="n">epub_path</span><span class="o">.</span><span class="n">name</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">epub_path</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">processed_path</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">result</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;original_path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">epub_path</span><span class="p">),</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="s1">&#39;processed_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="c1"># Move problematic file to processed directory</span>
            <span class="n">processed_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;ERROR_</span><span class="si">{</span><span class="n">epub_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">epub_path</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">processed_path</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract standardized metadata.&quot;&quot;&quot;</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">metadata</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
            <span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;creator&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
            <span class="s1">&#39;publisher&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;publisher&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
            <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
            <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_year</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;identifier&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
            <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_year</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract year from date string.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">date_str</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">date_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">date_str</span> <span class="k">else</span> <span class="n">date_str</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_epub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Basic EPUB validation.&quot;&quot;&quot;</span>
        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">metadata</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Missing title&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;creator&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Missing author&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Missing language&#39;</span><span class="p">)</span>

            <span class="c1"># Check for content</span>
            <span class="n">manifest</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">manifest</span>
            <span class="n">has_content</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;media-type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;application/xhtml+xml&#39;</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">manifest</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_content</span><span class="p">:</span>
                <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;No content files found&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Validation error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="n">issues</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_file_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epub_path</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate file information.&quot;&quot;&quot;</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">epub_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">epub_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;size_bytes&#39;</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_size</span><span class="p">,</span>
            <span class="s1">&#39;size_mb&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">st_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;file_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get_files_info</span><span class="p">()),</span>
            <span class="s1">&#39;modified&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_organized_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an organized filename from metadata.&quot;&quot;&quot;</span>
        <span class="c1"># Clean strings for filename</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">clean_for_filename</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^\w\s-]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="mi">50</span><span class="p">]</span>

        <span class="n">author</span> <span class="o">=</span> <span class="n">clean_for_filename</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;Unknown_Author&#39;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">clean_for_filename</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;Unknown_Title&#39;</span><span class="p">)</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;Unknown_Year&#39;</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">author</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">).epub&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">organize_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epub_path</span><span class="p">,</span> <span class="n">new_filename</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Organize file into structured directory.&quot;&quot;&quot;</span>
        <span class="c1"># Create author directory</span>
        <span class="n">author</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;Unknown_Author&#39;</span>
        <span class="n">author_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="n">author</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span>  <span class="c1"># Limit length</span>
        <span class="n">author_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Create final path</span>
        <span class="n">final_path</span> <span class="o">=</span> <span class="n">author_dir</span> <span class="o">/</span> <span class="n">new_filename</span>

        <span class="c1"># Copy file to organized location</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">epub_path</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">final_path</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">final_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate processing report.&quot;&quot;&quot;</span>
        <span class="n">report_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;processing_report_</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.json&quot;</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;total_files&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
            <span class="s1">&#39;successful&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;success&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;generated_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">results</span>
        <span class="p">}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">report_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing complete!&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully processed: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;successful&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Errors: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Report saved to: </span><span class="si">{</span><span class="n">report_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Usage</span>
<span class="n">processor</span> <span class="o">=</span> <span class="n">EPUBProcessor</span><span class="p">(</span>
    <span class="n">input_dir</span><span class="o">=</span><span class="s2">&quot;/path/to/new/epubs&quot;</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;/path/to/organized/library&quot;</span><span class="p">,</span>
    <span class="n">processed_dir</span><span class="o">=</span><span class="s2">&quot;/path/to/processed/files&quot;</span>
<span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process_new_files</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="command-line-power-user-examples">
<h2>Command-Line Power User Examples<a class="headerlink" href="#command-line-power-user-examples" title="Permalink to this heading">#</a></h2>
<section id="advanced-shell-scripts">
<h3>Advanced Shell Scripts<a class="headerlink" href="#advanced-shell-scripts" title="Permalink to this heading">#</a></h3>
<p><strong>Complex metadata extraction with error handling</strong>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># advanced-epub-analysis.sh</span>

<span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail

<span class="nv">EPUB_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="p">./</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">OUTPUT_FILE</span><span class="o">=</span><span class="s2">&quot;detailed_analysis.json&quot;</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Starting advanced EPUB analysis...&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Directory: </span><span class="nv">$EPUB_DIR</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Output: </span><span class="nv">$OUTPUT_FILE</span><span class="s2">&quot;</span>

<span class="c1"># Initialize JSON output</span>
<span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;{&quot;analysis_date&quot;: &quot;&#39;</span><span class="k">$(</span>date<span class="w"> </span>-Iseconds<span class="k">)</span><span class="s1">&#39;&quot;, &quot;epubs&quot;: [&#39;</span><span class="w"> </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OUTPUT_FILE</span><span class="s2">&quot;</span>

<span class="nv">first</span><span class="o">=</span><span class="nb">true</span>
find<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$EPUB_DIR</span><span class="s2">&quot;</span><span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.epub&quot;</span><span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>epub<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Analyzing: </span><span class="k">$(</span>basename<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$first</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">first</span><span class="o">=</span><span class="nb">false</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;,&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OUTPUT_FILE</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># Start JSON object for this EPUB</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;  {&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OUTPUT_FILE</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;    \&quot;file\&quot;: \&quot;</span><span class="nv">$epub</span><span class="s2">\&quot;,&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OUTPUT_FILE</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># Extract metadata with error handling</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">metadata</span><span class="o">=</span><span class="k">$(</span>epub-utils<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub</span><span class="s2">&quot;</span><span class="w"> </span>metadata<span class="w"> </span>--format<span class="w"> </span>kv<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;    \&quot;metadata\&quot;: {&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OUTPUT_FILE</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="c1"># Parse metadata into JSON</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$metadata</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39;: &#39;</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>key<span class="w"> </span>value<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$key</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$value</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      \&quot;</span><span class="nv">$key</span><span class="s2">\&quot;: \&quot;</span><span class="nv">$value</span><span class="s2">\&quot;,&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OUTPUT_FILE</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">        </span><span class="k">done</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;$s/,$//&#39;</span><span class="w"> </span><span class="c1"># Remove last comma</span>

<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;    },&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OUTPUT_FILE</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;    \&quot;metadata\&quot;: null,&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OUTPUT_FILE</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;    \&quot;metadata_error\&quot;: true,&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OUTPUT_FILE</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># File analysis</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nv">file_info</span><span class="o">=</span><span class="k">$(</span>epub-utils<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub</span><span class="s2">&quot;</span><span class="w"> </span>files<span class="w"> </span>--format<span class="w"> </span>raw<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">file_count</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file_info</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l<span class="k">)</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;    \&quot;file_count\&quot;: </span><span class="nv">$file_count</span><span class="s2">,&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OUTPUT_FILE</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;    \&quot;file_count\&quot;: null,&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OUTPUT_FILE</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># File size</span>
<span class="w">    </span><span class="nv">size</span><span class="o">=</span><span class="k">$(</span>stat<span class="w"> </span>-f%z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="o">||</span><span class="w"> </span>stat<span class="w"> </span>-c%s<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="k">)</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;    \&quot;size_bytes\&quot;: </span><span class="nv">$size</span><span class="s2">,&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OUTPUT_FILE</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># Validation check</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>epub-utils<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub</span><span class="s2">&quot;</span><span class="w"> </span>container<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>epub-utils<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub</span><span class="s2">&quot;</span><span class="w"> </span>package<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;    \&quot;is_valid\&quot;: true&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OUTPUT_FILE</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;    \&quot;is_valid\&quot;: false&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OUTPUT_FILE</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  }&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OUTPUT_FILE</span><span class="s2">&quot;</span>
<span class="k">done</span>

<span class="c1"># Close JSON</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;]}&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OUTPUT_FILE</span><span class="s2">&quot;</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Analysis complete! Results in </span><span class="nv">$OUTPUT_FILE</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p><strong>Batch processing with parallel execution</strong>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># parallel-epub-check.sh</span>

<span class="nv">EPUB_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="p">./</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">MAX_JOBS</span><span class="o">=</span><span class="m">4</span>

<span class="nb">export</span><span class="w"> </span>-f<span class="w"> </span>check_single_epub
check_single_epub<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nv">epub</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">base</span><span class="o">=</span><span class="k">$(</span>basename<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub</span><span class="s2">&quot;</span><span class="k">)</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[</span><span class="nv">$base</span><span class="s2">] Starting check...&quot;</span>

<span class="w">    </span><span class="c1"># Quick validation</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>epub-utils<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub</span><span class="s2">&quot;</span><span class="w"> </span>container<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[</span><span class="nv">$base</span><span class="s2">] ❌ Invalid container&quot;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>epub-utils<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub</span><span class="s2">&quot;</span><span class="w"> </span>package<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[</span><span class="nv">$base</span><span class="s2">] ❌ Invalid package&quot;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># Check for required metadata</span>
<span class="w">    </span><span class="nv">metadata</span><span class="o">=</span><span class="k">$(</span>epub-utils<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$epub</span><span class="s2">&quot;</span><span class="w"> </span>metadata<span class="w"> </span>--format<span class="w"> </span>kv<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="k">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$metadata</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s2">&quot;^title:&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[</span><span class="nv">$base</span><span class="s2">] ⚠️  Missing title&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$metadata</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s2">&quot;^creator:&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[</span><span class="nv">$base</span><span class="s2">] ⚠️  Missing author&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[</span><span class="nv">$base</span><span class="s2">] ✅ Check complete&quot;</span>
<span class="o">}</span>

<span class="c1"># Run parallel checks</span>
find<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$EPUB_DIR</span><span class="s2">&quot;</span><span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.epub&quot;</span><span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
xargs<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span>-P<span class="w"> </span><span class="nv">$MAX_JOBS</span><span class="w"> </span>-I<span class="w"> </span><span class="o">{}</span><span class="w"> </span>bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;check_single_epub &quot;$@&quot;&#39;</span><span class="w"> </span>_<span class="w"> </span><span class="o">{}</span>
</pre></div>
</div>
</section>
</section>
<section id="navigation-and-table-of-contents">
<h2>Navigation and Table of Contents<a class="headerlink" href="#navigation-and-table-of-contents" title="Permalink to this heading">#</a></h2>
<section id="working-with-epub-navigation-documents">
<h3>Working with EPUB Navigation Documents<a class="headerlink" href="#working-with-epub-navigation-documents" title="Permalink to this heading">#</a></h3>
<p><strong>Scenario</strong>: Extract and analyze navigation structures from both EPUB 2 and EPUB 3 files.</p>
<p><strong>CLI Approach - Version-Specific TOC Access</strong>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># extract-navigation.sh - Extract navigation from EPUB files</span>

<span class="nv">EPUB_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$EPUB_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Usage: </span><span class="nv">$0</span><span class="s2"> &lt;epub-file&gt;&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Analyzing navigation in: </span><span class="k">$(</span>basename<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$EPUB_FILE</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;========================================&quot;</span>

<span class="c1"># Try EPUB 3 nav document first</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Attempting EPUB 3 nav document extraction...&quot;</span>
<span class="k">if</span><span class="w"> </span>epub-utils<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$EPUB_FILE</span><span class="s2">&quot;</span><span class="w"> </span>toc<span class="w"> </span>--nav<span class="w"> </span>&gt;<span class="w"> </span>/tmp/nav.xml<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;✅ EPUB 3 nav document found&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Navigation structure:&quot;</span>
<span class="w">    </span><span class="c1"># Extract navigation items with their hierarchy</span>
<span class="w">    </span>grep<span class="w"> </span>-o<span class="w"> </span><span class="s1">&#39;&lt;a[^&gt;]*href=&quot;[^&quot;]*&quot;[^&gt;]*&gt;[^&lt;]*&lt;/a&gt;&#39;</span><span class="w"> </span>/tmp/nav.xml<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>sed<span class="w"> </span><span class="s1">&#39;s/&lt;a[^&gt;]*href=&quot;\([^&quot;]*\)&quot;[^&gt;]*&gt;\([^&lt;]*\)&lt;\/a&gt;/  → \2 (\1)/&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>head<span class="w"> </span>-10

<span class="w">    </span><span class="c1"># Count navigation items</span>
<span class="w">    </span><span class="nv">nav_count</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;&lt;a[^&gt;]*href=&#39;</span><span class="w"> </span>/tmp/nav.xml<span class="k">)</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Total navigation items: </span><span class="nv">$nav_count</span><span class="s2">&quot;</span>
<span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;❌ No EPUB 3 nav document found&quot;</span>
<span class="k">fi</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Attempting EPUB 2 NCX extraction...&quot;</span>
<span class="k">if</span><span class="w"> </span>epub-utils<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$EPUB_FILE</span><span class="s2">&quot;</span><span class="w"> </span>toc<span class="w"> </span>--ncx<span class="w"> </span>&gt;<span class="w"> </span>/tmp/ncx.xml<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;✅ EPUB 2 NCX document found&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Table of contents structure:&quot;</span>
<span class="w">    </span><span class="c1"># Extract NCX navigation points</span>
<span class="w">    </span>grep<span class="w"> </span>-o<span class="w"> </span><span class="s1">&#39;&lt;navLabel&gt;&lt;text&gt;[^&lt;]*&lt;/text&gt;&lt;/navLabel&gt;&#39;</span><span class="w"> </span>/tmp/ncx.xml<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>sed<span class="w"> </span><span class="s1">&#39;s/&lt;navLabel&gt;&lt;text&gt;\([^&lt;]*\)&lt;\/text&gt;&lt;\/navLabel&gt;/  → \1/&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>head<span class="w"> </span>-10

<span class="w">    </span><span class="c1"># Count NCX nav points</span>
<span class="w">    </span><span class="nv">ncx_count</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;&lt;navPoint&#39;</span><span class="w"> </span>/tmp/ncx.xml<span class="k">)</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Total NCX navigation points: </span><span class="nv">$ncx_count</span><span class="s2">&quot;</span>
<span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;❌ No EPUB 2 NCX document found&quot;</span>
<span class="k">fi</span>

<span class="c1"># Compare standard TOC with version-specific extracts</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Standard TOC extraction:&quot;</span>
<span class="nv">standard_toc</span><span class="o">=</span><span class="k">$(</span>epub-utils<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$EPUB_FILE</span><span class="s2">&quot;</span><span class="w"> </span>toc<span class="w"> </span>--format<span class="w"> </span>raw<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l<span class="k">)</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Standard TOC items: </span><span class="nv">$standard_toc</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p><strong>Python Approach - Advanced Navigation Analysis</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">epub_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xml.etree.ElementTree</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ET</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span><span class="w"> </span><span class="nc">NavigationAnalyzer</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epub_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span><span class="n">epub_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epub_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">epub_path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_navigation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Comprehensive navigation analysis.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyzing: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epub_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

        <span class="c1"># Check EPUB version</span>
        <span class="n">version</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EPUB Version: </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

        <span class="c1"># Analyze EPUB 3 nav document</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_nav_document</span><span class="p">()</span>

        <span class="c1"># Analyze EPUB 2 NCX document</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_ncx_document</span><span class="p">()</span>

        <span class="c1"># Compare with standard TOC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_standard_toc</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_analyze_nav_document</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyze EPUB 3 navigation document.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EPUB 3 Navigation Document Analysis:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">nav_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">nav</span>
            <span class="k">if</span> <span class="n">nav_content</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Nav document found&quot;</span><span class="p">)</span>

                <span class="c1"># Parse navigation structure</span>
                <span class="n">nav_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_nav_structure</span><span class="p">(</span><span class="n">nav_content</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Navigation items found: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nav_items</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Show hierarchy</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Navigation hierarchy:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">nav_items</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>  <span class="c1"># Show first 10</span>
                    <span class="n">indent</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s2">→ </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nav_items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nav_items</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="si">}</span><span class="s2"> more items&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ No nav document found&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Error accessing nav document: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_analyze_ncx_document</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyze EPUB 2 NCX document.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EPUB 2 NCX Document Analysis:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ncx_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">ncx</span>
            <span class="k">if</span> <span class="n">ncx_content</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ NCX document found&quot;</span><span class="p">)</span>

                <span class="c1"># Parse NCX structure</span>
                <span class="n">ncx_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_ncx_structure</span><span class="p">(</span><span class="n">ncx_content</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NCX navigation points: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ncx_items</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Show structure</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">NCX structure:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ncx_items</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>  <span class="c1"># Show first 10</span>
                    <span class="n">indent</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s2">→ </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ncx_items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ncx_items</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="si">}</span><span class="s2"> more items&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ No NCX document found&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Error accessing NCX document: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_analyze_standard_toc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyze standard TOC extraction.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Standard TOC Analysis:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">22</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">toc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">get_toc</span><span class="p">()</span>
            <span class="n">toc_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">toc</span><span class="o">.</span><span class="n">get_nav_items</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Standard TOC items: </span><span class="si">{</span><span class="n">toc_items</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Show some items</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Standard TOC items:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">toc</span><span class="o">.</span><span class="n">get_nav_items</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">href</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Error with standard TOC: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_nav_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nav_content</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse EPUB 3 nav document structure.&quot;&quot;&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">nav_content</span><span class="p">)</span>
            <span class="c1"># Handle namespaces</span>
            <span class="n">namespaces</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;xhtml&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.w3.org/1999/xhtml&#39;</span><span class="p">}</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">parse_nav_list</span><span class="p">(</span><span class="n">ol_element</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">ol_element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//xhtml:li&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">):</span>
                    <span class="n">a_elem</span> <span class="o">=</span> <span class="n">li</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//xhtml:a&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">a_elem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="n">a_elem</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">href</span> <span class="o">=</span> <span class="n">a_elem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                            <span class="s1">&#39;href&#39;</span><span class="p">:</span> <span class="n">href</span><span class="p">,</span>
                            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">level</span>
                        <span class="p">})</span>

                        <span class="c1"># Check for nested lists</span>
                        <span class="n">nested_ol</span> <span class="o">=</span> <span class="n">li</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//xhtml:ol&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">nested_ol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">parse_nav_list</span><span class="p">(</span><span class="n">nested_ol</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Find main navigation</span>
            <span class="n">nav_elem</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//xhtml:nav[@*=&quot;toc&quot;]&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nav_elem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nav_elem</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//xhtml:nav&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">nav_elem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ol_elem</span> <span class="o">=</span> <span class="n">nav_elem</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//xhtml:ol&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ol_elem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">parse_nav_list</span><span class="p">(</span><span class="n">ol_elem</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">ET</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not parse nav XML: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">items</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_ncx_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncx_content</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse EPUB 2 NCX document structure.&quot;&quot;&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">ncx_content</span><span class="p">)</span>
            <span class="c1"># NCX namespace</span>
            <span class="n">namespaces</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ncx&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.daisy.org/z3986/2005/ncx/&#39;</span><span class="p">}</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">parse_nav_point</span><span class="p">(</span><span class="n">nav_point</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                <span class="c1"># Get label</span>
                <span class="n">nav_label</span> <span class="o">=</span> <span class="n">nav_point</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ncx:navLabel/ncx:text&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">nav_label</span><span class="o">.</span><span class="n">text</span> <span class="k">if</span> <span class="n">nav_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

                <span class="c1"># Get content source</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">nav_point</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ncx:content&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                    <span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="n">src</span><span class="p">,</span>
                    <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">level</span>
                <span class="p">})</span>

                <span class="c1"># Process child nav points</span>
                <span class="k">for</span> <span class="n">child_nav_point</span> <span class="ow">in</span> <span class="n">nav_point</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;ncx:navPoint&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">):</span>
                    <span class="n">parse_nav_point</span><span class="p">(</span><span class="n">child_nav_point</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Find all top-level navigation points</span>
            <span class="n">nav_map</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ncx:navMap&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nav_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">nav_point</span> <span class="ow">in</span> <span class="n">nav_map</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;ncx:navPoint&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">):</span>
                    <span class="n">parse_nav_point</span><span class="p">(</span><span class="n">nav_point</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">ET</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not parse NCX XML: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">items</span>

<span class="c1"># Usage examples</span>
<span class="k">def</span><span class="w"> </span><span class="nf">analyze_single_epub</span><span class="p">(</span><span class="n">epub_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyze a single EPUB file.&quot;&quot;&quot;</span>
    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">NavigationAnalyzer</span><span class="p">(</span><span class="n">epub_path</span><span class="p">)</span>
    <span class="n">analyzer</span><span class="o">.</span><span class="n">analyze_navigation</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">compare_navigation_across_epubs</span><span class="p">(</span><span class="n">epub_directory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compare navigation structures across multiple EPUB files.&quot;&quot;&quot;</span>
    <span class="n">epub_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">epub_directory</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.epub&quot;</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Comparing navigation across </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">epub_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> EPUB files&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">epub_path</span> <span class="ow">in</span> <span class="n">epub_files</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">epub_path</span><span class="p">))</span>

            <span class="c1"># Check what navigation documents are available</span>
            <span class="n">has_nav</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">nav</span><span class="p">)</span>
            <span class="n">has_ncx</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">ncx</span><span class="p">)</span>
            <span class="n">standard_toc_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get_toc</span><span class="p">()</span><span class="o">.</span><span class="n">get_nav_items</span><span class="p">())</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">epub_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;has_nav&#39;</span><span class="p">:</span> <span class="n">has_nav</span><span class="p">,</span>
                <span class="s1">&#39;has_ncx&#39;</span><span class="p">:</span> <span class="n">has_ncx</span><span class="p">,</span>
                <span class="s1">&#39;toc_items&#39;</span><span class="p">:</span> <span class="n">standard_toc_count</span><span class="p">,</span>
                <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
            <span class="p">})</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing </span><span class="si">{</span><span class="n">epub_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Print comparison table</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;File&#39;</span><span class="si">:</span><span class="s2">&lt;30</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Version&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Nav&#39;</span><span class="si">:</span><span class="s2">&lt;5</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;NCX&#39;</span><span class="si">:</span><span class="s2">&lt;5</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;TOC Items&#39;</span><span class="si">:</span><span class="s2">&lt;10</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">65</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">nav_mark</span> <span class="o">=</span> <span class="s2">&quot;✅&quot;</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;has_nav&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;❌&quot;</span>
        <span class="n">ncx_mark</span> <span class="o">=</span> <span class="s2">&quot;✅&quot;</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;has_ncx&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;❌&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;30</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nav_mark</span><span class="si">:</span><span class="s2">&lt;5</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ncx_mark</span><span class="si">:</span><span class="s2">&lt;5</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;toc_items&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;10</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Example usage</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Analyze single file</span>
    <span class="n">analyze_single_epub</span><span class="p">(</span><span class="s2">&quot;/path/to/your/book.epub&quot;</span><span class="p">)</span>

    <span class="c1"># Compare multiple files</span>
    <span class="n">compare_navigation_across_epubs</span><span class="p">(</span><span class="s2">&quot;/path/to/epub/collection&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="building-smart-reading-lists">
<h3>Building Smart Reading Lists<a class="headerlink" href="#building-smart-reading-lists" title="Permalink to this heading">#</a></h3>
<p><strong>Scenario</strong>: Create curated reading lists based on navigation complexity and structure.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">epub_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ReadingListBuilder</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">books</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_book_complexity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epub_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyze book&#39;s structural complexity.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">epub_path</span><span class="p">))</span>

            <span class="c1"># Get navigation info</span>
            <span class="n">toc_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get_toc</span><span class="p">()</span><span class="o">.</span><span class="n">get_nav_items</span><span class="p">())</span>
            <span class="n">has_advanced_nav</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">nav</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">ncx</span><span class="p">)</span>

            <span class="c1"># Get file structure info</span>
            <span class="n">files_info</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_files_info</span><span class="p">()</span>
            <span class="n">html_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files_info</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;media_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;application/xhtml+xml&#39;</span><span class="p">]</span>

            <span class="n">complexity_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_complexity_score</span><span class="p">(</span>
                <span class="n">toc_items</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">html_files</span><span class="p">),</span> <span class="n">has_advanced_nav</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">epub_path</span><span class="p">,</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;creator&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;toc_items&#39;</span><span class="p">:</span> <span class="n">toc_items</span><span class="p">,</span>
                <span class="s1">&#39;html_files&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">html_files</span><span class="p">),</span>
                <span class="s1">&#39;has_advanced_nav&#39;</span><span class="p">:</span> <span class="n">has_advanced_nav</span><span class="p">,</span>
                <span class="s1">&#39;complexity_score&#39;</span><span class="p">:</span> <span class="n">complexity_score</span><span class="p">,</span>
                <span class="s1">&#39;complexity_level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_complexity_level</span><span class="p">(</span><span class="n">complexity_score</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error analyzing </span><span class="si">{</span><span class="n">epub_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_complexity_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toc_items</span><span class="p">,</span> <span class="n">html_files</span><span class="p">,</span> <span class="n">has_advanced_nav</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate structural complexity score.&quot;&quot;&quot;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># TOC complexity</span>
        <span class="k">if</span> <span class="n">toc_items</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">30</span>
        <span class="k">elif</span> <span class="n">toc_items</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">20</span>
        <span class="k">elif</span> <span class="n">toc_items</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">10</span>

        <span class="c1"># File structure complexity</span>
        <span class="k">if</span> <span class="n">html_files</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">25</span>
        <span class="k">elif</span> <span class="n">html_files</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">15</span>
        <span class="k">elif</span> <span class="n">html_files</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">10</span>

        <span class="c1"># Advanced navigation features</span>
        <span class="k">if</span> <span class="n">has_advanced_nav</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">15</span>

        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># Cap at 100</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_complexity_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert score to complexity level.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Advanced&quot;</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">40</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Intermediate&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Beginner&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_reading_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epub_directory</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;reading_lists.json&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build categorized reading lists.&quot;&quot;&quot;</span>
        <span class="n">epub_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">epub_directory</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.epub&quot;</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyzing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">epub_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> EPUB files for reading lists...&quot;</span><span class="p">)</span>

        <span class="c1"># Analyze all books</span>
        <span class="k">for</span> <span class="n">epub_path</span> <span class="ow">in</span> <span class="n">epub_files</span><span class="p">:</span>
            <span class="n">book_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_book_complexity</span><span class="p">(</span><span class="n">epub_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">book_info</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">books</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">book_info</span><span class="p">)</span>

        <span class="c1"># Categorize books</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">books</span><span class="p">:</span>
            <span class="c1"># By complexity</span>
            <span class="n">categories</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;complexity_</span><span class="si">{</span><span class="n">book</span><span class="p">[</span><span class="s1">&#39;complexity_level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>

            <span class="c1"># By navigation richness</span>
            <span class="k">if</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;toc_items&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">categories</span><span class="p">[</span><span class="s1">&#39;detailed_structure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;has_advanced_nav&#39;</span><span class="p">]:</span>
                <span class="n">categories</span><span class="p">[</span><span class="s1">&#39;advanced_navigation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>

        <span class="c1"># Create final reading lists</span>
        <span class="n">reading_lists</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;beginner_friendly&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Books with simple structure, perfect for casual reading&#39;</span><span class="p">,</span>
                <span class="s1">&#39;books&#39;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">categories</span><span class="p">[</span><span class="s1">&#39;complexity_beginner&#39;</span><span class="p">],</span>
                              <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;toc_items&#39;</span><span class="p">])[:</span><span class="mi">10</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;intermediate_reads&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Well-structured books with moderate complexity&#39;</span><span class="p">,</span>
                <span class="s1">&#39;books&#39;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">categories</span><span class="p">[</span><span class="s1">&#39;complexity_intermediate&#39;</span><span class="p">],</span>
                              <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;complexity_score&#39;</span><span class="p">])[:</span><span class="mi">15</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;advanced_studies&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Complex books with rich navigation, ideal for research&#39;</span><span class="p">,</span>
                <span class="s1">&#39;books&#39;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">categories</span><span class="p">[</span><span class="s1">&#39;complexity_advanced&#39;</span><span class="p">],</span>
                              <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;complexity_score&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;detailed_references&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Books with detailed table of contents&#39;</span><span class="p">,</span>
                <span class="s1">&#39;books&#39;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">categories</span><span class="p">[</span><span class="s1">&#39;detailed_structure&#39;</span><span class="p">],</span>
                              <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;toc_items&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">12</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;enhanced_navigation&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Books with advanced navigation features&#39;</span><span class="p">,</span>
                <span class="s1">&#39;books&#39;</span><span class="p">:</span> <span class="n">categories</span><span class="p">[</span><span class="s1">&#39;advanced_navigation&#39;</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1"># Save to file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">reading_lists</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

        <span class="c1"># Print summary</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reading Lists Generated:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">25</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">list_name</span><span class="p">,</span> <span class="n">list_data</span> <span class="ow">in</span> <span class="n">reading_lists</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">list_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">list_data</span><span class="p">[</span><span class="s1">&#39;books&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> books&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  → </span><span class="si">{</span><span class="n">list_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Saved to: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Usage</span>
<span class="n">builder</span> <span class="o">=</span> <span class="n">ReadingListBuilder</span><span class="p">()</span>
<span class="n">builder</span><span class="o">.</span><span class="n">build_reading_lists</span><span class="p">(</span><span class="s2">&quot;/path/to/epub/collection&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>These examples demonstrate the power and flexibility of <code class="docutils literal notranslate"><span class="pre">epub-utils</span></code> for various real-world scenarios. Whether you’re managing a digital library, performing quality assurance, building automated workflows, or analyzing navigation structures, epub-utils provides the tools you need to work effectively with EPUB files.</p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="formats.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Output Formats Reference</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="api-tutorial.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Use as a Python library</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Ernesto González
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Examples and Use Cases</a><ul>
<li><a class="reference internal" href="#digital-library-management">Digital Library Management</a><ul>
<li><a class="reference internal" href="#cataloging-your-epub-collection">Cataloging Your EPUB Collection</a></li>
</ul>
</li>
<li><a class="reference internal" href="#quality-assurance-and-validation">Quality Assurance and Validation</a><ul>
<li><a class="reference internal" href="#epub-health-check">EPUB Health Check</a></li>
</ul>
</li>
<li><a class="reference internal" href="#metadata-management">Metadata Management</a><ul>
<li><a class="reference internal" href="#standardizing-metadata">Standardizing Metadata</a></li>
</ul>
</li>
<li><a class="reference internal" href="#content-analysis-and-statistics">Content Analysis and Statistics</a><ul>
<li><a class="reference internal" href="#reading-level-analysis">Reading Level Analysis</a></li>
<li><a class="reference internal" href="#direct-file-access-and-extraction">Direct File Access and Extraction</a></li>
</ul>
</li>
<li><a class="reference internal" href="#automation-and-workflows">Automation and Workflows</a><ul>
<li><a class="reference internal" href="#automated-epub-processing-pipeline">Automated EPUB Processing Pipeline</a></li>
</ul>
</li>
<li><a class="reference internal" href="#command-line-power-user-examples">Command-Line Power User Examples</a><ul>
<li><a class="reference internal" href="#advanced-shell-scripts">Advanced Shell Scripts</a></li>
</ul>
</li>
<li><a class="reference internal" href="#navigation-and-table-of-contents">Navigation and Table of Contents</a><ul>
<li><a class="reference internal" href="#working-with-epub-navigation-documents">Working with EPUB Navigation Documents</a></li>
<li><a class="reference internal" href="#building-smart-reading-lists">Building Smart Reading Lists</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/scripts/furo.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    </body>
</html>